<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Weather</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,0" />
    <script src="/assets/gurapp/api/gurasuraisu-api.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            /* Fallback background if gradient fails */
            background-color: var(--background-color-tr); 
            min-height: 100vh;
            color: var(--text-color);
            transition: color 0.3s;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            user-select: none;
        }

        /* Dynamic Weather Background Container */
        #dynamic-weather-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            transition: opacity 0.5s ease;
        }

        #dynamic-weather-background::after {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            /* Pseudo-gradient overlay for complex lighting */
            background: var(--pseudo-gradient, transparent);
            opacity: 0.6;
            pointer-events: none;
            transition: opacity 1s ease;
        }

        /* Weather Elements CSS (Imported from Legacy) */
        .weather-elements-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }

        /* Sun */
        .sun { position: absolute; border-radius: 50%; z-index: 2; }
        .sun.morning { width: 60px; height: 60px; background: #ffe87c; box-shadow: 0 0 30px #ff9500, 0 0 60px #ffcb70; left: 10%; top: 20%; }
        .sun.midday { width: 70px; height: 70px; background: #fff9c4; box-shadow: 0 0 40px #ffee58, 0 0 80px #ffeb3b; left: 50%; top: 15%; transform: translateX(-50%); }
        .sun.evening { width: 60px; height: 60px; background: #ff9800; box-shadow: 0 0 30px #ff5722, 0 0 60px #ef6c00; right: 10%; top: 20%; }
        .sun.behind-clouds { opacity: 0.7; filter: blur(2px); }

        /* Sunrays */
        .sunrays { position: absolute; z-index: 1; }
        .sunrays.morning { width: 100px; height: 100px; background: radial-gradient(circle, rgba(255, 236, 95, 0.4) 0%, rgba(255, 236, 95, 0) 70%); left: 10%; top: 20%; transform: translate(-20px, -20px); animation: pulsate 4s infinite ease-in-out; }
        .sunrays.midday { width: 120px; height: 120px; background: radial-gradient(circle, rgba(255, 245, 157, 0.5) 0%, rgba(255, 245, 157, 0) 70%); left: 50%; top: 15%; transform: translate(-60px, -25px); animation: pulsate 4s infinite ease-in-out; }
        .sunrays.evening { width: 100px; height: 100px; background: radial-gradient(circle, rgba(255, 152, 0, 0.4) 0%, rgba(255, 152, 0, 0) 70%); right: 10%; top: 20%; transform: translate(20px, -20px); animation: pulsate 4s infinite ease-in-out; }
        .sunrays.faded { opacity: 0.6; }

        /* Moon */
        .moon { position: absolute; width: 50px; height: 50px; background: #e6e6e6; border-radius: 50%; box-shadow: 0 0 20px rgba(255, 255, 255, 0.4); right: 15%; top: 15%; z-index: 2; }
        .moon.night { background: linear-gradient(45deg, #e6e6e6, #ffffff); box-shadow: 0 0 20px rgba(255, 255, 255, 0.3), 0 0 40px rgba(255, 255, 255, 0.1); }
        .moon.behind-clouds { opacity: 0.7; filter: blur(1px); }

        /* Stars */
        .stars { position: absolute; width: 100%; height: 100%; background-image: radial-gradient(1px 1px at 25% 15%, white, rgba(255, 255, 255, 0)), radial-gradient(1px 1px at 50% 25%, white, rgba(255, 255, 255, 0)), radial-gradient(1px 1px at 75% 5%, white, rgba(255, 255, 255, 0)), radial-gradient(1.5px 1.5px at 15% 45%, white, rgba(255, 255, 255, 0)), radial-gradient(1.5px 1.5px at 35% 65%, white, rgba(255, 255, 255, 0)), radial-gradient(1px 1px at 85% 35%, white, rgba(255, 255, 255, 0)), radial-gradient(1.5px 1.5px at 65% 75%, white, rgba(255, 255, 255, 0)), radial-gradient(1px 1px at 95% 55%, white, rgba(255, 255, 255, 0)); z-index: 1; }
        .stars.faded { opacity: 0.6; }
        .stars.sparse { background-image: radial-gradient(1px 1px at 25% 15%, white, rgba(255, 255, 255, 0)), radial-gradient(1px 1px at 75% 5%, white, rgba(255, 255, 255, 0)), radial-gradient(1.5px 1.5px at 35% 65%, white, rgba(255, 255, 255, 0)), radial-gradient(1px 1px at 85% 35%, white, rgba(255, 255, 255, 0)); }

        /* Clouds */
        .clouds { position: absolute; width: 100%; height: 100%; z-index: 3; pointer-events: none; }
        .clouds.few::before, .clouds.few::after { content: ''; position: absolute; background: rgba(255, 255, 255, 0.8); border-radius: 50%; filter: blur(10px); }
        .clouds.few::before { width: 100px; height: 60px; left: 20%; top: 15%; }
        .clouds.few::after { width: 120px; height: 70px; right: 25%; top: 20%; }
        
        .clouds.scattered::before { content: ''; position: absolute; width: 200px; height: 60px; background: rgba(255, 255, 255, 0.85); border-radius: 50px; left: 10%; top: 15%; filter: blur(8px); box-shadow: 100px -10px 0 rgba(255, 255, 255, 0.8), 180px 20px 0 rgba(255, 255, 255, 0.7); }
        .clouds.scattered::after { content: ''; position: absolute; width: 160px; height: 40px; background: rgba(255, 255, 255, 0.8); border-radius: 40px; right: 15%; top: 20%; filter: blur(5px); box-shadow: -70px 15px 0 rgba(255, 255, 255, 0.75); }
        
        .clouds.overcast::before { content: ''; position: absolute; width: 120%; height: 200px; background: rgba(180, 180, 180, 0.9); border-radius: 100px; top: -50px; left: -10%; filter: blur(15px); box-shadow: 0 30px 0 rgba(175, 175, 175, 0.85), 0 60px 0 rgba(170, 170, 170, 0.8), 0 90px 0 rgba(165, 165, 165, 0.75); }
        
        .clouds.broken::before { content: ''; position: absolute; width: 100%; height: 50px; background: rgba(220, 220, 220, 0.9); border-radius: 50px; top: 10%; filter: blur(10px); box-shadow: 0 25px 0 rgba(210, 210, 210, 0.8), 0 50px 0 rgba(200, 200, 200, 0.7), 0 75px 0 rgba(190, 190, 190, 0.6); }
        
        .clouds.dark::before { content: ''; position: absolute; width: 120%; height: 200px; background: rgba(100, 100, 110, 0.9); border-radius: 100px; top: -50px; left: -10%; filter: blur(15px); box-shadow: 0 30px 0 rgba(90, 90, 100, 0.85), 0 60px 0 rgba(80, 80, 90, 0.8), 0 90px 0 rgba(70, 70, 80, 0.75); }
        
        .clouds.thunderstorm::before { content: ''; position: absolute; width: 120%; height: 200px; background: rgba(60, 60, 70, 0.95); border-radius: 100px; top: -50px; left: -10%; filter: blur(15px); box-shadow: 0 30px 0 rgba(55, 55, 65, 0.9), 0 60px 0 rgba(50, 50, 60, 0.85), 0 90px 0 rgba(45, 45, 55, 0.8); }

        /* Rain */
        .raindrop { position: absolute; width: 2px; background: linear-gradient(to bottom, rgba(200, 200, 255, 0.8) 0%, rgba(200, 200, 255, 0.4) 50%, transparent 100%); border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%; animation: fall linear infinite; }
        .rain.light .raindrop { height: 15px; animation-duration: 1.2s; }
        .rain.medium .raindrop { height: 20px; width: 2.5px; animation-duration: 0.8s; background: linear-gradient(to bottom, rgba(190, 190, 255, 0.9) 0%, rgba(190, 190, 255, 0.5) 50%, transparent 100%); }
        .rain.heavy .raindrop { height: 25px; width: 3px; animation-duration: 0.6s; background: linear-gradient(to bottom, rgba(180, 180, 255, 1) 0%, rgba(180, 180, 255, 0.7) 50%, transparent 100%); }
        .drizzle .raindrop { height: 8px; width: 1px; animation-duration: 1.8s; background: linear-gradient(to bottom, rgba(200, 200, 255, 0.5) 0%, rgba(200, 200, 255, 0.2) 50%, transparent 100%); }

        /* Snow */
        .snow { position: absolute; width: 100%; height: 100%; z-index: 4; animation: snow 10s linear infinite; }
        .snow.light { opacity: 0.7; animation-duration: 12s; background-image: radial-gradient(2px 2px at 10% 10%, rgba(255, 255, 255, 0.8), transparent), radial-gradient(2px 2px at 30% 30%, rgba(255, 255, 255, 0.8), transparent), radial-gradient(2px 2px at 50% 50%, rgba(255, 255, 255, 0.8), transparent); background-size: 400px 400px; }
        .snow.medium { opacity: 0.8; animation-duration: 10s; background-image: radial-gradient(2px 2px at 5% 5%, rgba(255, 255, 255, 0.8), transparent), radial-gradient(2px 2px at 25% 25%, rgba(255, 255, 255, 0.8), transparent), radial-gradient(2px 2px at 45% 45%, rgba(255, 255, 255, 0.8), transparent), radial-gradient(2px 2px at 65% 65%, rgba(255, 255, 255, 0.8), transparent), radial-gradient(2px 2px at 85% 85%, rgba(255, 255, 255, 0.8), transparent); background-size: 300px 300px; }
        
        /* Other Effects */
        .fog { position: absolute; width: 100%; height: 100%; background: linear-gradient(to bottom, rgba(220, 220, 220, 0.7) 0%, rgba(220, 220, 220, 0.5) 50%, rgba(220, 220, 220, 0) 100%); animation: fog 10s ease-in-out infinite alternate; z-index: 3; }
        .lightning { position: absolute; width: 100%; height: 100%; z-index: 5; }
        .lightning::before { content: ''; position: absolute; width: 5px; height: 200px; background: linear-gradient(to bottom, rgba(255, 255, 255, 0.9), transparent); transform: rotate(15deg); top: 10%; left: 40%; filter: blur(1px); opacity: 0; animation: lightning 6s infinite; }

        @keyframes pulsate { 0% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); opacity: 0.8; } }
        @keyframes fall { 0% { transform: translateY(-100vh) rotate(0deg); opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { transform: translateY(100vh) rotate(2deg); opacity: 0; } }
        @keyframes snow { 0% { background-position: 0 0; opacity: 0.7; } 50% { opacity: 1; } 100% { background-position: 500px 1000px; opacity: 0.7; } }
        @keyframes fog { 0% { opacity: 0.5; } 100% { opacity: 0.8; } }
        @keyframes lightning { 0%, 1%, 3%, 6%, 100% { opacity: 0; } 2%, 4% { opacity: 1; } }

        .view-container {
            flex-grow: 1;
            width: 100%;
            height: 100vh;
            padding: 80px 20px 20px 20px;
            overflow-y: auto;
            overflow-x: hidden;
            display: none;
            flex-direction: column;
            align-items: center;
            z-index: 2; /* Content above background */
        }

        .view-container.active {
            display: flex;
        }

        .page-content-wrapper {
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
		
		.nav-btn {
		    background-color: transparent;
			border: none;
			padding: 8px;
		}

        .item-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
            width: 100%;
        }

        .item-card {
            /* Cards now semi-transparent to show dynamic background */
            background-color: var(--search-background);
            border-radius: 35px;
            corner-shape: superellipse(1.5);
            padding: 20px;
            transition: all 0.2s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 10px;
            border: 1px solid var(--glass-border);
            backdrop-filter: var(--edge-refraction-filter) saturate(2) blur(2.5px);
            box-shadow: var(--sun-shadow);
            position: relative;
            overflow: hidden;
        }

		#locations-grid .item-card {
			gap: 0;
			aspect-ratio: 1 / 1;
		    justify-content: space-between;
		}

        .item-card:active {
            transform: scale(0.96);
            filter: brightness(1.5);
        }

        .item-card-title {
            font-weight: 600;
            font-size: 1.1rem;
            font-family: 'Open Runde', sans-serif;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .item-card-subtitle {
            font-size: 0.9rem;
            color: var(--secondary-text-color);
        }

        .item-card-big-text {
            font-size: 2.5rem;
            font-weight: 700;
            font-family: 'Open Runde', sans-serif;
            margin: 5px 0;
        }

        .highlight-card {
            background: var(--search-background);
            border: 1px solid var(--glass-border);
            border-radius: 35px;
            corner-shape: superellipse(1.5);
            padding: 20px 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            width: 100%;
            box-shadow: var(--sun-shadow);
            backdrop-filter: var(--edge-refraction-filter) saturate(2) blur(2.5px);
            min-height: 160px;
        }

        .highlight-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .highlight-temp {
            font-size: 4rem;
            font-weight: 700;
            font-family: 'Open Runde', sans-serif;
            line-height: 1;
        }

        .highlight-city {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .highlight-condition {
            color: var(--secondary-text-color);
            font-size: 1.1rem;
        }

        .highlight-icon {
            font-size: 80px;
            color: var(--text-color);
        }

        .search-container {
            width: 100%;
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px 15px 12px 45px;
            border-radius: 25px;
            border: 1px solid var(--glass-border);
            background: var(--search-background);
            color: var(--text-color);
            backdrop-filter: var(--edge-refraction-filter) saturate(2) blur(5px);
            box-shadow: var(--sun-shadow);
            font-size: 16px;
            outline: none;
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary-text-color);
            pointer-events: none;
        }

        .item-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
        }

        .list-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            background-color: var(--search-background);
            border-radius: 35px;
            corner-shape: superellipse(1.5);
            border: 1px solid var(--glass-border);
            color: var(--text-color);
            cursor: pointer;
            backdrop-filter: var(--edge-refraction-filter) saturate(2) blur(5px);
            box-shadow: var(--sun-shadow);
            justify-content: space-between;
        }
        
        .list-item:active {
            transform: scale(0.98);
            filter: brightness(1.2);
        }

        .list-item-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .list-item-title {
            font-weight: 600;
            font-size: 1rem;
        }

        .list-item-subtitle {
            font-size: 0.85rem;
            color: var(--secondary-text-color);
        }

        /* Weather Specifics */
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            width: 100%;
        }

        .stat-card {
            background-color: var(--search-background);
            border-radius: 35px;
			corner-shape: superellipse(1.5);
            padding: 15px;
            border: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            gap: 5px;
            backdrop-filter: var(--edge-refraction-filter) saturate(2) blur(5px);
			box-shadow: var(--sun-shadow);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--secondary-text-color);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-value {
            font-size: 1.4rem;
            font-weight: 600;
            font-family: 'Open Runde';
        }

        .hourly-scroll {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            width: 100%;
            scrollbar-width: none;
			border-radius: 10px;
        }
        
        .hourly-scroll::-webkit-scrollbar { display: none; }

        .hourly-item {
            min-width: 10%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 15px 20px;
            background: var(--search-background);
            border-radius: 100px;
            border: 1px solid var(--glass-border);
            backdrop-filter: var(--edge-refraction-filter) saturate(2) blur(5px);
			box-shadow: var(--sun-shadow);
        }
		
		@media (max-width: 800px) {
			.hourly-item {
				background: transparent;
				backdrop-filter: none;
				box-shadow: none;
				border: none;
			}
			
			.hourly-scroll {
			    background: var(--search-background);
				border: 1px solid var(--glass-border);
				border-radius: 35px;
				corner-shape: superellipse(1.5);
				padding: 0 10px;
				backdrop-filter: var(--edge-refraction-filter) saturate(2) blur(5px);
				box-shadow: var(--sun-shadow);
			}
		}

        .section-header {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 10px 0;
            font-family: 'Open Runde';
        }

        .delete-btn {
            background: rgba(255, 100, 100, 0.2);
            border: 1px solid var(--glass-border);
            color: #ff6b6b;
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loading-spinner {
            animation: spin 1s linear infinite;
            color: var(--secondary-text-color);
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body data-app-name="WEATHER">
    <!-- Shared Glass Filter -->
    <svg style="display: none">
        <filter id="edge-refraction-only" color-interpolation-filters="linearRGB">
            <feTurbulence type="fractalNoise" baseFrequency="0.04" numOctaves="2" result="turbulence"></feTurbulence>
            <feMorphology in="SourceGraphic" operator="erode" radius="4" result="eroded"></feMorphology>
            <feComposite in="SourceGraphic" in2="eroded" operator="out" result="border_mask"></feComposite>
            <feComposite in="turbulence" in2="border_mask" operator="in" result="edge_turbulence"></feComposite>
            <feDisplacementMap in="SourceGraphic" in2="edge_turbulence" scale="15" xChannelSelector="R" yChannelSelector="G" result="disp_positive"></feDisplacementMap>
            <feDisplacementMap in="SourceGraphic" in2="edge_turbulence" scale="-15" xChannelSelector="R" yChannelSelector="G" result="disp_negative"></feDisplacementMap>
            <feFlood flood-color="white" width="50%" height="50%" x="0" y="0" result="topLeftRect"></feFlood>
            <feFlood flood-color="white" width="50%" height="50%" x="50%" y="50%" result="bottomRightRect"></feFlood>
            <feComposite in="disp_positive" in2="topLeftRect" operator="in" result="topLeft_part"></feComposite>
            <feComposite in="disp_negative" in2="bottomRightRect" operator="in" result="bottomRight_part"></feComposite>
            <feBlend in="topLeft_part" in2="bottomRight_part" mode="lighten" result="blended_image"></feBlend>
            <feComponentTransfer in="blended_image"><feFuncA type="linear" slope="0.95"></feFuncA></feComponentTransfer>
        </filter>
    </svg>

    <!-- Dynamic Background Layer -->
    <div id="dynamic-weather-background">
        <div id="weather-effects-layer" class="weather-elements-container"></div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
        <button class="tab-btn active" data-view="locations">
            <span class="material-symbols-rounded">home</span>
            Home
        </button>
        <button class="tab-btn" data-view="search">
            <span class="material-symbols-rounded">search</span>
            Search
        </button>
    </div>

    <!-- Locations Grid View -->
    <div id="locations-view" class="view-container active">
        <div class="page-content-wrapper">
            <div id="locations-grid" class="item-grid">
                <!-- Location cards injected here -->
            </div>
			<a href="https://open-meteo.com/" target="_blank" style="font-size: small;color: var(--text-color);text-decoration: none;position: absolute;bottom: 20px;">Data from Open-Meteo</a>
            <div id="loading-locations" style="display:none; justify-content:center;">
                <span class="material-symbols-rounded loading-spinner" style="font-size: 32px;">progress_activity</span>
            </div>
        </div>
    </div>

    <!-- Search View -->
    <div id="search-view" class="view-container">
        <div class="page-content-wrapper">
            <div class="search-container">
                <span class="material-symbols-rounded search-icon" style="z-index: 1;">search</span>
                <input type="text" id="city-search-input" class="search-input" placeholder="Search for a location">
            </div>
            <div id="search-results" class="item-list">
                <!-- Search results injected here -->
            </div>
        </div>
    </div>

    <!-- Detailed Weather View -->
    <div id="details-view" class="view-container">
        <div class="page-content-wrapper">
            <!-- Main Highlight Card -->
            <div class="highlight-card" id="detail-main-card">
                <div class="highlight-info">
                    <div class="highlight-city" id="detail-city">City Name</div>
                    <div class="highlight-temp" id="detail-temp">--Â°</div>
                    <div class="highlight-condition" id="detail-condition">Condition</div>
                    <div class="item-card-subtitle" id="detail-hl">ðŸ¡¡ --Â° ðŸ¡£ --Â°</div>
                </div>
                <span class="material-symbols-rounded highlight-icon" id="detail-icon" style="font-size: 64px; padding-right: 25px;">cloud</span>
            </div>
			
            <!-- Hourly Forecast -->
            <div class="hourly-scroll" id="detail-hourly">
                <!-- Hourly items injected here -->
            </div>

            <!-- Stats Grid -->
            <div class="stat-grid">
                <div class="stat-card">
                    <div class="stat-label"><span class="material-symbols-rounded" style="font-size:18px;">thermostat</span> Feels Like</div>
                    <div class="stat-value" id="detail-feels">--Â°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label"><span class="material-symbols-rounded" style="font-size:18px;">humidity_percentage</span> Humidity</div>
                    <div class="stat-value" id="detail-humidity">--%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label"><span class="material-symbols-rounded" style="font-size:18px;">air</span> Wind</div>
                    <div class="stat-value" id="detail-wind">-- km/h</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label"><span class="material-symbols-rounded" style="font-size:18px;">light_mode</span> UV Index</div>
                    <div class="stat-value" id="detail-uv">--</div>
                </div>
            </div>

            <!-- Daily Forecast -->
            <div class="item-list" id="detail-daily">
                <!-- Daily items injected here -->
            </div>

            <button class="nav-btn" id="delete-location-btn" style="color: #ff6b6b; margin-top: 20px;">
                Remove Location
            </button>
        </div>
    </div>

    <script>
        // --- State Management ---
        let savedLocations = JSON.parse(localStorage.getItem('weather_locations')) || [];
        let currentLocationIndex = null;
        let searchTimeout = null;
        let savedSystemTheme = localStorage.getItem('theme') || 'dark';
        
        sessionStorage.setItem('restoreTheme', savedSystemTheme);
        let currentWeatherTheme = null;

        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'themeUpdate') {
                savedSystemTheme = event.data.theme;
                sessionStorage.setItem('restoreTheme', savedSystemTheme);
                if (document.getElementById('details-view').classList.contains('active') && currentWeatherTheme !== null) {
                    document.body.classList.toggle('light-theme', currentWeatherTheme);
                }
            }
        });

        // --- Extensive Weather Definitions (from Legacy) ---
        function isDaytime() {
            const hour = new Date().getHours();
            return hour >= 6 && hour <= 18;
        }

        const weatherConditions = {
            0: { description: 'Clear Sky', icon: (isDay) => isDay ? 'clear_day' : 'clear_night' },
            1: { description: 'Mainly Clear', icon: (isDay) => isDay ? 'partly_cloudy_day' : 'partly_cloudy_night' },
            2: { description: 'Partly Cloudy', icon: (isDay) => isDay ? 'partly_cloudy_day' : 'partly_cloudy_night' },
            3: { description: 'Overcast', icon: () => 'cloud' },
            45: { description: 'Fog', icon: () => 'foggy' },
            48: { description: 'Depositing Rime Fog', icon: () => 'foggy' },
            51: { description: 'Light Drizzle', icon: () => 'rainy_light' },
            53: { description: 'Moderate Drizzle', icon: () => 'rainy' },
            55: { description: 'Dense Drizzle', icon: () => 'rainy' },
            56: { description: 'Light Freezing Drizzle', icon: () => 'weather_hail' },
            57: { description: 'Dense Freezing Drizzle', icon: () => 'weather_hail' },
            61: { description: 'Slight Rain', icon: () => 'rainy_light' },
            63: { description: 'Moderate Rain', icon: () => 'rainy' },
            65: { description: 'Heavy Rain', icon: () => 'rainy_heavy' },
            66: { description: 'Light Freezing Rain', icon: () => 'weather_mix' },
            67: { description: 'Heavy Freezing Rain', icon: () => 'weather_mix' },
            71: { description: 'Slight Snow', icon: () => 'weather_snowy' },
            73: { description: 'Moderate Snow', icon: () => 'weather_snowy' },
            75: { description: 'Heavy Snow', icon: () => 'weather_snowy' },
            77: { description: 'Snow Grains', icon: () => 'weather_snowy' },
            80: { description: 'Slight Showers', icon: () => 'rainy_light' },
            81: { description: 'Moderate Showers', icon: () => 'rainy' },
            82: { description: 'Violent Showers', icon: () => 'thunderstorm' },
            85: { description: 'Slight Snow Showers', icon: () => 'weather_snowy' },
            86: { description: 'Heavy Snow Showers', icon: () => 'weather_snowy' },
            95: { description: 'Thunderstorm', icon: () => 'thunderstorm' },
            96: { description: 'Thunderstorm with Hail', icon: () => 'thunderstorm' },
            99: { description: 'Heavy Thunderstorm', icon: () => 'thunderstorm' }
        };

        function getWeatherInfo(code, isDay = true) {
            const condition = weatherConditions[code] || { description: 'Unknown', icon: () => 'question_mark' };
            return {
                desc: condition.description,
                icon: condition.icon(isDay)
            };
        }

        // --- Weather Effects Logic (From Legacy) ---
        function getWindClass(windSpeed) {
            if (windSpeed >= 25) return 'very-windy';
            if (windSpeed >= 15) return 'windy';
            return '';
        }

        function createRaindrops(container, intensity = 'medium') {
            const existingDrops = container.querySelectorAll('.raindrop');
            existingDrops.forEach(drop => drop.remove());
            
            const isWindy = container.classList.contains('windy');
            const isVeryWindy = container.classList.contains('very-windy');
            
            const dropCounts = { 'drizzle': 25, 'light': 50, 'medium': 100, 'heavy': 180 };
            const dropCount = dropCounts[intensity] || 100;
            const baseDurations = { 'drizzle': '1.8s', 'light': '1.2s', 'medium': '0.8s', 'heavy': '0.6s' };
            
            container.style.setProperty('--base-duration', baseDurations[intensity]);
            
            for (let i = 0; i < dropCount; i++) {
                const raindrop = document.createElement('div');
                raindrop.className = 'raindrop';
                raindrop.style.left = Math.random() * 100 + '%';
                raindrop.style.animationDelay = Math.random() * 2 + 's';
                
                if (isWindy || isVeryWindy) {
                    const baseDuration = parseFloat(baseDurations[intensity]);
                    const variation = (Math.random() - 0.5) * 0.4;
                    raindrop.style.animationDuration = (baseDuration + variation) + 's';
                    const horizontalOffset = (Math.random() - 0.5) * 10;
                    raindrop.style.left = (Math.random() * 100 + horizontalOffset) + '%';
                }
                container.appendChild(raindrop);
            }
        }

        // --- Background Gradient Transition ---
        function parseRGB(rgbString) {
            const values = rgbString.match(/\d+/g);
            if (!values || values.length < 3) {
                return { r: 0, g: 0, b: 0 };
            }
            return {
                r: parseInt(values[0]),
                g: parseInt(values[1]),
                b: parseInt(values[2])
            };
        }

        function interpolateColor(color1, color2, progress) {
            const r = Math.round(color1.r + (color2.r - color1.r) * progress);
            const g = Math.round(color1.g + (color2.g - color1.g) * progress);
            const b = Math.round(color1.b + (color2.b - color1.b) * progress);
            return `rgb(${r}, ${g}, ${b})`;
        }

        let currentAnimationInterval = null;

        function transitionGradient(element, startGradient, endGradient, duration = 1000) {
            if (currentAnimationInterval) clearInterval(currentAnimationInterval);

            // If startGradient is computed as 'none' or invalid, default to black
            if (!startGradient || startGradient === 'none') startGradient = 'linear-gradient(rgb(0,0,0), rgb(0,0,0))';

            const startColors = startGradient.match(/rgb\(\s*\d+\s*,\s*\d+\s*,\s*\d+\s*\)/g) || ['rgb(0,0,0)', 'rgb(0,0,0)'];
            const endColors = endGradient.match(/rgb\(\s*\d+\s*,\s*\d+\s*,\s*\d+\s*\)/g) || ['rgb(0,0,0)', 'rgb(0,0,0)'];

            // Ensure we have 2 colors
            if (startColors.length < 2) startColors.push(startColors[0]);
            if (endColors.length < 2) endColors.push(endColors[0]);

            const fps = 60;
            const frameCount = (duration / 1000) * fps;
            let frame = 0;

            currentAnimationInterval = setInterval(() => {
                frame++;
                const progress = frame / frameCount;
                
                if (progress >= 1) {
                    element.style.background = endGradient;
                    clearInterval(currentAnimationInterval);
                    return;
                }

                const c1 = interpolateColor(parseRGB(startColors[0]), parseRGB(endColors[0]), progress);
                const c2 = interpolateColor(parseRGB(startColors[startColors.length - 1]), parseRGB(endColors[endColors.length - 1]), progress);
                
                element.style.background = `linear-gradient(${c1}, ${c2})`;
            }, 1000 / fps);
        }

        function updateWeatherBackground(weatherCode, timezone, windSpeed) {
            const backgroundEl = document.getElementById('dynamic-weather-background');
            const effectsLayer = document.getElementById('weather-effects-layer');
            
            // Calculate time of day based on timezone
            const now = new Date();
            const localTime = new Date(now.toLocaleString("en-US", {timeZone: timezone || 'UTC'}));
            const hour = localTime.getHours();
            
            // Refined Time Logic (Mutually Exclusive)
            const isMorning = hour >= 6 && hour < 10;
            const isMidday = hour >= 10 && hour < 16;
            const isEvening = hour >= 16 && hour < 20;
            // Night covers everything else (20:00 - 06:00)
            
            // Theme Switching Logic
            // Morning/Midday = Bright = Light Theme (Dark Text)
            // Evening/Night = Dark/Saturated = Dark Theme (Light Text)
            const useLightTheme = isMorning || isMidday;
            document.body.classList.toggle('light-theme', useLightTheme);
            currentWeatherTheme = useLightTheme;
            
            const windClass = getWindClass(windSpeed);
            const rainIntensity = weatherCode >= 80 ? 'heavy' : (weatherCode >= 63 ? 'medium' : 'light');

            let gradientColors = '';
            let pseudoGradientColors = '';
            let weatherElements = '';

            // Updated Switch Logic based on new time variables
            if (isMorning) {
                // Morning Logic
                switch (weatherCode) {
                    case 0: gradientColors = 'linear-gradient(rgb(135, 206, 235), rgb(255, 183, 107))'; pseudoGradientColors = 'linear-gradient(rgb(255, 128, 0), rgb(255, 215, 0))'; weatherElements = '<div class="sun morning"></div><div class="sunrays morning"></div>'; break;
                    case 1: gradientColors = 'linear-gradient(rgb(100, 181, 246), rgb(255, 213, 167))'; weatherElements = '<div class="sun morning"></div><div class="clouds few morning"></div>'; break;
                    case 2: gradientColors = 'linear-gradient(rgb(129, 195, 236), rgb(219, 217, 198))'; weatherElements = '<div class="sun morning behind-clouds"></div><div class="clouds scattered morning"></div>'; break;
                    case 3: gradientColors = 'linear-gradient(rgb(176, 190, 197), rgb(207, 216, 220))'; weatherElements = '<div class="clouds overcast morning"></div>'; break;
                    case 61: case 63: case 65: gradientColors = 'linear-gradient(rgb(96, 146, 178), rgb(161, 183, 195))'; weatherElements = `<div class="clouds dark morning"></div><div class="rain morning ${rainIntensity} ${windClass}"></div>`; break;
                    case 95: gradientColors = 'linear-gradient(rgb(67, 90, 120), rgb(108, 128, 147))'; weatherElements = `<div class="clouds thunderstorm morning"></div><div class="rain heavy morning ${windClass}"></div><div class="lightning morning"></div>`; break;
                    default: gradientColors = 'linear-gradient(rgb(135, 206, 235), rgb(255, 183, 107))'; weatherElements = '<div class="sun morning"></div>';
                }
            } else if (isMidday) {
                // Midday Logic
                switch (weatherCode) {
                    case 0: gradientColors = 'linear-gradient(rgb(0, 191, 255), rgb(135, 206, 250))'; pseudoGradientColors = 'linear-gradient(rgb(255, 236, 179), rgb(255, 255, 240))'; weatherElements = '<div class="sun midday"></div><div class="sunrays midday"></div>'; break;
                    case 1: case 2: gradientColors = 'linear-gradient(rgb(30, 144, 255), rgb(135, 206, 250))'; weatherElements = '<div class="sun midday"></div><div class="clouds few midday"></div>'; break;
                    case 3: gradientColors = 'linear-gradient(rgb(137, 152, 170), rgb(189, 198, 207))'; weatherElements = '<div class="clouds overcast midday"></div>'; break;
                    case 61: case 63: case 65: gradientColors = 'linear-gradient(rgb(62, 146, 204), rgb(124, 169, 207))'; weatherElements = `<div class="clouds dark midday"></div><div class="rain midday ${rainIntensity} ${windClass}"></div>`; break;
                    case 95: gradientColors = 'linear-gradient(rgb(47, 79, 103), rgb(86, 105, 124))'; weatherElements = `<div class="clouds thunderstorm midday"></div><div class="rain heavy midday ${windClass}"></div><div class="lightning midday"></div>`; break;
                    default: gradientColors = 'linear-gradient(rgb(0, 191, 255), rgb(135, 206, 250))'; weatherElements = '<div class="sun midday"></div>';
                }
            } else if (isEvening) {
                // Evening Logic
                switch (weatherCode) {
                    case 0: gradientColors = 'linear-gradient(rgb(65, 105, 225), rgb(255, 128, 0))'; pseudoGradientColors = 'linear-gradient(rgb(255, 69, 0), rgb(255, 215, 0))'; weatherElements = '<div class="sun evening"></div><div class="sunrays evening"></div>'; break;
                    case 1: case 2: gradientColors = 'linear-gradient(rgb(70, 130, 180), rgb(255, 160, 122))'; weatherElements = '<div class="sun evening"></div><div class="clouds few evening"></div>'; break;
                    case 61: case 63: case 65: gradientColors = 'linear-gradient(rgb(54, 92, 125), rgb(121, 143, 161))'; weatherElements = `<div class="clouds dark evening"></div><div class="rain evening ${rainIntensity} ${windClass}"></div>`; break;
                    default: gradientColors = 'linear-gradient(rgb(65, 105, 225), rgb(255, 128, 0))'; weatherElements = '<div class="sun evening"></div>';
                }
            } else {
                // Night Logic
                switch (weatherCode) {
                    case 0: gradientColors = 'linear-gradient(rgb(10, 15, 50), rgb(25, 25, 70))'; pseudoGradientColors = 'linear-gradient(rgb(0, 0, 30), rgb(15, 15, 45))'; weatherElements = '<div class="stars night"></div><div class="moon night"></div>'; break;
                    case 1: case 2: gradientColors = 'linear-gradient(rgb(15, 20, 55), rgb(30, 30, 75))'; weatherElements = '<div class="stars night faded"></div><div class="moon night"></div><div class="clouds few night"></div>'; break;
                    case 3: gradientColors = 'linear-gradient(rgb(30, 35, 45), rgb(45, 50, 60))'; weatherElements = '<div class="clouds overcast night"></div>'; break;
                    case 61: case 63: case 65: gradientColors = 'linear-gradient(rgb(20, 30, 45), rgb(35, 45, 60))'; weatherElements = `<div class="clouds dark night"></div><div class="rain night ${rainIntensity} ${windClass}"></div>`; break;
                    default: gradientColors = 'linear-gradient(rgb(10, 15, 50), rgb(25, 25, 70))'; weatherElements = '<div class="stars night"></div><div class="moon night"></div>';
                }
            }

            // Apply Changes with Transition
            const currentBg = window.getComputedStyle(backgroundEl).backgroundImage;
            // Use the new transition function
            transitionGradient(backgroundEl, currentBg, gradientColors, 1000);
            
            backgroundEl.style.setProperty('--pseudo-gradient', pseudoGradientColors);
            effectsLayer.innerHTML = weatherElements;

            // Initialize dynamic elements like rain
            setTimeout(() => {
                const rainElements = document.querySelectorAll('.rain, .drizzle');
                rainElements.forEach(el => {
                    let intensity = 'medium';
                    if (el.classList.contains('light')) intensity = 'light';
                    if (el.classList.contains('heavy')) intensity = 'heavy';
                    if (el.classList.contains('drizzle')) intensity = 'drizzle';
                    createRaindrops(el, intensity);
                });
            }, 50);
        }

        // --- View Switching ---
        const views = {
            locations: document.getElementById('locations-view'),
            search: document.getElementById('search-view'),
            details: document.getElementById('details-view')
        };

        function switchView(viewName) {
            Object.values(views).forEach(el => el.classList.remove('active'));
            views[viewName].classList.add('active');
            
            // Update Toolbar
            document.querySelectorAll('.toolbar .tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === viewName);
            });

            // Bug fix: Reset background/theme when leaving details
            const bg = document.getElementById('dynamic-weather-background');
            const effects = document.getElementById('weather-effects-layer');

            if (viewName === 'locations' || viewName === 'search') {
                // Reset to default theme
                document.body.classList.toggle('light-theme', savedSystemTheme === 'light');
                const restoredTheme = sessionStorage.getItem('restoreTheme');
                if (restoredTheme) document.body.classList.toggle('light-theme', restoredTheme === 'light');
                
                // Hide dynamic background
                if (bg) {
                    bg.style.opacity = '0';
                    setTimeout(() => {
                        if (bg.style.opacity === '0') {
                            bg.style.setProperty('--pseudo-gradient', 'transparent');
                        }
                    }, 500);
                }
                
                // Clear weather effects
                if (effects) effects.innerHTML = '';

                if (viewName === 'locations') {
                    renderLocationsGrid();
                }
            } else if (viewName === 'details') {
                // Show dynamic background
                if (bg) bg.style.opacity = '1';
            }
        }

        document.querySelectorAll('.toolbar .tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (btn.dataset.view) switchView(btn.dataset.view);
            });
        });

        // --- Data Fetching ---
        async function fetchWeather(lat, lon) {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,is_day,precipitation,rain,weather_code,wind_speed_10m&hourly=temperature_2m,weather_code,is_day&daily=weather_code,temperature_2m_max,temperature_2m_min,uv_index_max,precipitation_probability_max&timezone=auto`;
            try {
                const res = await fetch(url);
                return await res.json();
            } catch (e) {
                console.error("Weather fetch failed", e);
                return null;
            }
        }

        // --- Locations Logic ---
        async function renderLocationsGrid() {
            const grid = document.getElementById('locations-grid');
            grid.innerHTML = '';
            
            if (savedLocations.length === 0) {
                // Try to get current location automatically if list is empty
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    const { latitude, longitude } = pos.coords;
                    // Reverse geocode mostly for the name
                    try {
                        const geoRes = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
                        const geoData = await geoRes.json();
                        const city = geoData.address.city || geoData.address.town || "My Location";
                        
                        const newLoc = { id: Date.now(), name: city, lat: latitude, lon: longitude, country: geoData.address.country };
                        savedLocations.push(newLoc);
                        localStorage.setItem('weather_locations', JSON.stringify(savedLocations));
                        renderLocationsGrid();
                    } catch(e) {}
                }, () => {
                    grid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; color: var(--secondary-text-color);">No locations saved.<br>Use "Add City" to start.</div>`;
                });
                return;
            }

            document.getElementById('loading-locations').style.display = 'flex';

            // Create cards
            for (let i = 0; i < savedLocations.length; i++) {
                const loc = savedLocations[i];
                // Fetch simple current weather for the card
                const data = await fetchWeather(loc.lat, loc.lon);
                
                if (data && data.current) {
                    const info = getWeatherInfo(data.current.weather_code, data.current.is_day);
                    
                    const card = document.createElement('div');
                    card.className = 'item-card';
                    card.innerHTML = `
                        <div class="item-card-title">${loc.name}</div>
                        <div class="item-card-big-text">${Math.round(data.current.temperature_2m)}Â°</div>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span class="material-symbols-rounded" style="font-size: 32px;">${info.icon}</span>
							<div class="item-card-subtitle">ðŸ¡¡ ${Math.round(data.daily.temperature_2m_max[0])}Â° ðŸ¡£ ${Math.round(data.daily.temperature_2m_min[0])}Â°</div>
                        </div>
                    	<span class="item-card-subtitle">${info.desc}</span>
                    `;
                    card.onclick = () => openDetails(i, data);
                    grid.appendChild(card);
                }
            }
            document.getElementById('loading-locations').style.display = 'none';
        }

        // --- Search Logic ---
        const searchInput = document.getElementById('city-search-input');
        const searchResults = document.getElementById('search-results');

        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();
            if (query.length < 3) return;

            searchTimeout = setTimeout(async () => {
                searchResults.innerHTML = '<div style="padding:20px; text-align:center;"><span class="material-symbols-rounded loading-spinner">progress_activity</span></div>';
                try {
                    const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=10&language=en&format=json`);
                    const data = await res.json();
                    
                    searchResults.innerHTML = '';
                    if (data.results) {
                        data.results.forEach(city => {
                            const div = document.createElement('div');
                            div.className = 'list-item';
                            div.innerHTML = `
                                <div class="list-item-left">
                                    <span class="material-symbols-rounded">location_city</span>
                                    <div>
                                        <div class="list-item-title">${city.name}</div>
                                        <div class="list-item-subtitle">${city.admin1 || ''}, ${city.country}</div>
                                    </div>
                                </div>
                                <span class="material-symbols-rounded">add_circle</span>
                            `;
                            div.onclick = () => addLocation(city);
                            searchResults.appendChild(div);
                        });
                    } else {
                        searchResults.innerHTML = '<div style="padding:20px; text-align:center;">No results found</div>';
                    }
                } catch (e) {
                    console.error(e);
                    searchResults.innerHTML = '<div style="padding:20px; text-align:center;">Error searching</div>';
                }
            }, 500);
        });

        function addLocation(cityData) {
            const newLoc = {
                id: cityData.id,
                name: cityData.name,
                lat: cityData.latitude,
                lon: cityData.longitude,
                country: cityData.country
            };
            
            // Check duplicates
            if (!savedLocations.some(l => l.id === newLoc.id)) {
                savedLocations.push(newLoc);
                localStorage.setItem('weather_locations', JSON.stringify(savedLocations));
                Gurasuraisu.showPopup(`Added ${cityData.name}`);
            }
            
            searchInput.value = '';
            searchResults.innerHTML = '';
            switchView('locations');
        }

        // --- Detailed View Logic ---
        function openDetails(index, preloadedData) {
            currentLocationIndex = index;
            const loc = savedLocations[index];
            const data = preloadedData; 

            if (!data) return;

            // Trigger Background Update with proper timezone from API
            // The API response contains 'timezone' and 'timezone_abbreviation'
            updateWeatherBackground(
                data.current.weather_code, 
                data.timezone, 
                data.current.wind_speed_10m
            );

            // Header
            document.getElementById('detail-city').textContent = loc.name;
            document.getElementById('detail-temp').textContent = Math.round(data.current.temperature_2m) + 'Â°';
            
            const curInfo = getWeatherInfo(data.current.weather_code, data.current.is_day);
            document.getElementById('detail-condition').textContent = curInfo.desc;
            document.getElementById('detail-icon').textContent = curInfo.icon;
            document.getElementById('detail-hl').textContent = `ðŸ¡¡ ${Math.round(data.daily.temperature_2m_max[0])}Â° ðŸ¡£ ${Math.round(data.daily.temperature_2m_min[0])}Â°`;

            // Stats
            document.getElementById('detail-feels').textContent = Math.round(data.current.apparent_temperature) + 'Â°';
            document.getElementById('detail-humidity').textContent = data.current.relative_humidity_2m + '%';
            document.getElementById('detail-wind').textContent = data.current.wind_speed_10m + ' km/h';
            document.getElementById('detail-uv').textContent = data.daily.uv_index_max[0];

            // Hourly
            const hourlyContainer = document.getElementById('detail-hourly');
            hourlyContainer.innerHTML = '';
            
            // Get current hour index
            const now = new Date();
            // We need to find the index in the hourly array that corresponds to "now".
            // Since Open-Meteo hourly array starts at 00:00 today (local time of requested timezone usually, or UTC),
            // and we requested &timezone=auto, it returns local time.
            const currentHour = now.getHours();
            
            // Show next 24 hours
            for (let i = currentHour; i < currentHour + 24; i++) {
                if (!data.hourly.time[i]) break;
                
                const timeStr = data.hourly.time[i]; 
                const date = new Date(timeStr);
                const hourLabel = i === currentHour ? 'Now' : date.getHours().toString().padStart(2, '0');
                const temp = Math.round(data.hourly.temperature_2m[i]);
                const code = data.hourly.weather_code[i];
                const isDay = data.hourly.is_day[i];
                const info = getWeatherInfo(code, isDay);

                const div = document.createElement('div');
                div.className = 'hourly-item';
                div.innerHTML = `
                    <div style="font-size: 0.9rem; color: var(--secondary-text-color);">${hourLabel}</div>
                    <span class="material-symbols-rounded" style="font-size: 24px;">${info.icon}</span>
                    <div style="font-weight: 600;">${temp}Â°</div>
                `;
                hourlyContainer.appendChild(div);
            }

            // Daily
            const dailyContainer = document.getElementById('detail-daily');
            dailyContainer.innerHTML = '';
            
            for (let i = 0; i < 7; i++) {
                if (!data.daily.time[i]) break;
                
                const date = new Date(data.daily.time[i]);
                const dayName = i === 0 ? 'Today' : date.toLocaleDateString('en-US', { weekday: 'long' });
                const min = Math.round(data.daily.temperature_2m_min[i]);
                const max = Math.round(data.daily.temperature_2m_max[i]);
                const code = data.daily.weather_code[i];
                const info = getWeatherInfo(code, true); 
                const precip = data.daily.precipitation_probability_max[i];

                const div = document.createElement('div');
                div.className = 'list-item';
                div.style.cursor = 'default';
                div.innerHTML = `
                    <div style="width: 100px; font-weight: 500;">${dayName}</div>
                    <div style="display:flex; flex-direction:column; align-items:center; width: 40px;">
                        <span class="material-symbols-rounded">${info.icon}</span>
                        ${precip > 20 ? `<span style="font-size:0.7rem; color:#4facfe;">${precip}%</span>` : ''}
                    </div>
                    <div style="display: flex; gap: 10px; width: 100px; justify-content: flex-end;">
                        <span style="color: var(--secondary-text-color);">${min}Â°</span>
                        <span style="font-weight: 600;">${max}Â°</span>
                    </div>
                `;
                dailyContainer.appendChild(div);
            }

            switchView('details');
        }

		document.getElementById('delete-location-btn').addEventListener('click', async () => {
		    if (currentLocationIndex !== null) {
		        if (await Gurasuraisu.showConfirm("Remove this location?")) {
		            savedLocations.splice(currentLocationIndex, 1);
		            localStorage.setItem('weather_locations', JSON.stringify(savedLocations));
		            switchView('locations');
		        }
		    }
		});
		
        // --- Init ---
        window.addEventListener('load', () => {
            renderLocationsGrid();
        });

        window.addEventListener('GurasuraisuReady', () => {
            // Register the widget as soon as the API is confirmed to be ready.
            Gurasuraisu.registerWidget({
                appName: 'Weather',
                widgetId: 'weather-current',
                title: 'Current Weather',
                url: '/weather/widgets/current-weather.html',
                defaultSize: [1, 1],
                openUrl: '/weather/index.html'
            });
        });

    </script>
</body>
</html>
